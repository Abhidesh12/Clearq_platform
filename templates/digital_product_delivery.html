<!-- templates/digital_product_purchase.html -->
{% extends "base.html" %}

{% block title %}{{ service.name }} - Digital Product{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto py-8 px-4">
    <div class="bg-white shadow rounded-lg overflow-hidden">
        <div class="p-8">
            <!-- Product info -->
            <div class="mb-8">
                <h1 class="text-3xl font-bold text-gray-900 mb-2">{{ service.name }}</h1>
                <p class="text-gray-600 mb-4">by {{ mentor.full_name }}</p>
                <div class="prose max-w-none text-gray-700 mb-6">
                    {{ service.description|safe }}
                </div>
            </div>
            
            <!-- Price and Purchase Section -->
            <div class="border-t border-gray-200 pt-8">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">Get This Product</h2>
                
                <div class="bg-gray-50 rounded-lg p-6 mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <span class="text-3xl font-bold text-gray-900">
                                {% if service.price == 0 %}
                                Free
                                {% else %}
                                â‚¹{{ service.price }}
                                {% endif %}
                            </span>
                        </div>
                        
                        {% if service.price == 0 %}
                        <button onclick="purchaseFreeProduct({{ service.id }})"
                                class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                            <svg class="mr-2 h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                            Get for Free
                        </button>
                        {% else %}
                        <button onclick="purchaseProduct({{ service.id }})"
                                class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            <svg class="mr-2 h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            Purchase Now
                        </button>
                        {% endif %}
                    </div>
                    
                    <div class="text-sm text-gray-600">
                        <ul class="list-disc pl-5 space-y-1">
                            <li>Instant access after purchase</li>
                            <li>Download link available immediately</li>
                            <li>Lifetime access to updates</li>
                            <li>Money-back guarantee within 30 days</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
async function purchaseProduct(serviceId) {
    try {
        const response = await fetch('/api/purchase-digital-product', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ service_id: serviceId })
        });
        
        const result = await response.json();
        
        if (result.success) {
            if (result.redirect_url) {
                window.location.href = result.redirect_url;
            } else if (result.razorpay_order_id) {
                // Open payment page
                window.location.href = `/payment/${result.booking_id}`;
            }
        } else {
            // If user already owns the product, redirect to delivery page
            if (result.message && result.message.includes("already own")) {
                alert('You already own this product! Redirecting to your library...');
                window.location.href = `/digital-product/${serviceId}`;
            } else {
                alert(result.message || 'Purchase failed');
            }
        }
    } catch (error) {
        console.error('Error:', error);
        alert('An error occurred. Please try again.');
    }
}

async function purchaseFreeProduct(serviceId) {
    try {
        const response = await fetch('/api/purchase-digital-product', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ service_id: serviceId })
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('Product added to your library!');
            window.location.href = `/digital-product/${serviceId}`;
        } else {
            // If user already owns the product, redirect to delivery page
            if (result.message && result.message.includes("already own")) {
                alert('You already own this product! Redirecting to your library...');
                window.location.href = `/digital-product/${serviceId}`;
            } else {
                alert(result.message || 'Purchase failed');
            }
        }
    } catch (error) {
        console.error('Error:', error);
        alert('An error occurred. Please try again.');
    }
}
</script>
{% endblock %}
