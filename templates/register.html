{% extends "base.html" %}

{% block title %}Register - ClearQ{% endblock %}

{% block content %}
<!-- Add homepage Tailwind config and theme -->
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&amp;display=swap" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
<script>
    tailwind.config = {
        darkMode: "class",
        theme: {
            extend: {
                colors: {
                    "primary": "#1f1f1f",
                    "primary-hover": "#000000",
                    "accent": "#ff6b4a",
                    "background-light": "#fff5ec",
                    "background-dark": "#151022",
                    "text-light": "#1f1f1f",
                    "text-dark": "#ffffff",
                    "text-secondary-light": "#555555",
                    "text-secondary-dark": "#a09db3",
                    "card-light": "#ffffff",
                    "card-dark": "#1e1a2e",
                    "border-light": "#E5E4E0",
                    "border-dark": "#2d2a3b",
                    "accent-beige": "#F0EFEA",
                    "secondary": "#2D3748",
                    "dark-card": "#232936",
                    "card-purple": "#E0DBFC",
                    "card-green": "#9CCB5C",
                    "card-blue": "#85C3EA",
                    "card-beige": "#EEE3CD",
                    "card-teal": "#A8E1E1",
                    "card-pink": "#F6D0CE",
                    "brand-red": "#FF3F1F",
                },
                fontFamily: {
                    "display": ["Inter", "sans-serif"]
                },
                borderRadius: {
                    "DEFAULT": "0.25rem",
                    "lg": "0.5rem",
                    "xl": "0.75rem",
                    "2xl": "1rem",
                    "full": "9999px"
                },
                fontSize: {
                    'xxs': '0.625rem',
                }
            },
        }
    }
</script>

<div class="min-h-screen bg-gradient-to-br from-background-light to-white dark:from-background-dark dark:to-card-dark flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-md w-full space-y-8">
        <div class="text-center">
            <a href="/" class="flex items-center justify-center space-x-2 mb-8">
                <div class="w-12 h-12 rounded-lg bg-gradient-to-br from-accent to-accent/80 flex items-center justify-center">
                    <i class="fas fa-graduation-cap text-white text-xl"></i>
                </div>
                <span class="text-2xl font-bold text-text-light dark:text-text-dark">Clear<span class="text-accent">Q</span></span>
            </a>
            <h2 class="text-3xl font-bold text-text-light dark:text-text-dark">Create your account</h2>
            <p class="mt-2 text-sm text-text-secondary-light dark:text-text-secondary-dark">
                Join thousands of learners and mentors
            </p>
        </div>

        {% if google_auth_url %}
        <div class="mt-4">
            <a href="{{ google_auth_url }}" 
               class="w-full flex items-center justify-center px-4 py-3 border border-border-light dark:border-border-dark rounded-lg shadow-sm text-sm font-medium text-text-light dark:text-text-dark bg-card-light dark:bg-card-dark hover:bg-accent-beige dark:hover:bg-dark-card focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-accent transition-all">
                <i class="fab fa-google text-brand-red mr-2"></i>
                Continue with Google
            </a>
            <div class="mt-4 flex items-center">
                <div class="flex-grow border-t border-border-light dark:border-border-dark"></div>
                <span class="flex-shrink mx-4 text-text-secondary-light dark:text-text-secondary-dark text-sm">or</span>
                <div class="flex-grow border-t border-border-light dark:border-border-dark"></div>
            </div>
        </div>
        {% endif %}

        <form class="mt-8 space-y-6" action="/register" method="POST" id="register-form">
            <div class="rounded-md shadow-sm space-y-4">
                <div>
                    <label for="full_name" class="block text-sm font-medium text-text-light dark:text-text-dark mb-1">
                        Full Name *
                    </label>
                    <input id="full_name" name="full_name" type="text" required
                           class="appearance-none relative block w-full px-3 py-3 border border-border-light dark:border-border-dark placeholder:text-text-secondary-light dark:placeholder:text-text-secondary-dark text-text-light dark:text-text-dark rounded-lg focus:outline-none focus:ring-2 focus:ring-accent focus:border-transparent focus:z-10 sm:text-sm bg-card-light dark:bg-card-dark"
                           placeholder="John Doe">
                </div>

                <div>
                    <label for="email" class="block text-sm font-medium text-text-light dark:text-text-dark mb-1">
                        Email Address *
                    </label>
                    <input id="email" name="email" type="email" autocomplete="email" required
                           class="appearance-none relative block w-full px-3 py-3 border border-border-light dark:border-border-dark placeholder:text-text-secondary-light dark:placeholder:text-text-secondary-dark text-text-light dark:text-text-dark rounded-lg focus:outline-none focus:ring-2 focus:ring-accent focus:border-transparent focus:z-10 sm:text-sm bg-card-light dark:bg-card-dark"
                           placeholder="you@example.com">
                </div>

                <div>
                    <label for="username" class="block text-sm font-medium text-text-light dark:text-text-dark mb-1">
                        Username *
                    </label>
                    <input id="username" name="username" type="text" required
                           class="appearance-none relative block w-full px-3 py-3 border border-border-light dark:border-border-dark placeholder:text-text-secondary-light dark:placeholder:text-text-secondary-dark text-text-light dark:text-text-dark rounded-lg focus:outline-none focus:ring-2 focus:ring-accent focus:border-transparent focus:z-10 sm:text-sm bg-card-light dark:bg-card-dark"
                           placeholder="johndoe">
                </div>

                <div>
                    <label for="password" class="block text-sm font-medium text-text-light dark:text-text-dark mb-1">
                        Password *
                    </label>
                    <input id="password" name="password" type="password" autocomplete="new-password" required
                           class="appearance-none relative block w-full px-3 py-3 border border-border-light dark:border-border-dark placeholder:text-text-secondary-light dark:placeholder:text-text-secondary-dark text-text-light dark:text-text-dark rounded-lg focus:outline-none focus:ring-2 focus:ring-accent focus:border-transparent focus:z-10 sm:text-sm bg-card-light dark:bg-card-dark"
                           placeholder="••••••••">
                </div>

                <div>
                    <label for="role" class="block text-sm font-medium text-text-light dark:text-text-dark mb-1">
                        I want to join as *
                    </label>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <input type="radio" id="learner" name="role" value="learner" class="hidden peer" checked>
                            <label for="learner" 
                                   class="flex flex-col items-center justify-center p-4 border-2 border-border-light dark:border-border-dark rounded-lg cursor-pointer peer-checked:border-accent peer-checked:bg-accent/5 hover:bg-accent-beige dark:hover:bg-dark-card bg-card-light dark:bg-card-dark transition-all">
                                <i class="fas fa-user-graduate text-accent text-2xl mb-2"></i>
                                <span class="font-medium text-text-light dark:text-text-dark">Learner</span>
                                <span class="text-xs text-text-secondary-light dark:text-text-secondary-dark mt-1 text-center">Book sessions with mentors</span>
                            </label>
                        </div>
                        <div>
                            <input type="radio" id="mentor" name="role" value="mentor" class="hidden peer">
                            <label for="mentor" 
                                   class="flex flex-col items-center justify-center p-4 border-2 border-border-light dark:border-border-dark rounded-lg cursor-pointer peer-checked:border-accent peer-checked:bg-accent/5 hover:bg-accent-beige dark:hover:bg-dark-card bg-card-light dark:bg-card-dark transition-all">
                                <i class="fas fa-chalkboard-teacher text-accent text-2xl mb-2"></i>
                                <span class="font-medium text-text-light dark:text-text-dark">Mentor</span>
                                <span class="text-xs text-text-secondary-light dark:text-text-secondary-dark mt-1 text-center">Share your expertise</span>
                            </label>
                        </div>
                    </div>
                    <p class="mt-2 text-xs text-text-secondary-light dark:text-text-secondary-dark">
                        Note: Mentor accounts require admin verification before you can start accepting bookings.
                    </p>
                </div>

                <!-- Mentor Specific Fields (Hidden by default) -->
                <div id="mentor-fields" class="space-y-4 hidden transition-all duration-300 ease-in-out">
                    <div class="pt-4 border-t border-border-light dark:border-border-dark">
                        <h3 class="text-sm font-semibold text-text-light dark:text-text-dark mb-3 flex items-center">
                            <i class="fas fa-graduation-cap text-accent mr-2"></i>
                            Mentor Information
                        </h3>
                        
                        <!-- Bio Field -->
                        <div class="mb-4">
                            <label for="bio" class="block text-sm font-medium text-text-light dark:text-text-dark mb-1">
                                Bio
                            </label>
                            <textarea id="bio" 
                                      name="bio" 
                                      rows="3"
                                      class="appearance-none relative block w-full px-3 py-3 border border-border-light dark:border-border-dark placeholder:text-text-secondary-light dark:placeholder:text-text-secondary-dark text-text-light dark:text-text-dark rounded-lg focus:outline-none focus:ring-2 focus:ring-accent focus:border-transparent focus:z-10 sm:text-sm bg-card-light dark:bg-card-dark"
                                      placeholder="Tell learners about your experience, expertise, and mentoring style..."></textarea>
                            <p class="mt-1 text-xs text-text-secondary-light dark:text-text-secondary-dark">This will appear on your public mentor profile</p>
                        </div>

                        <!-- Industry Field -->
                        <div class="mb-4">
                            <label for="industry" class="block text-sm font-medium text-text-light dark:text-text-dark mb-2">
                                <i class="fas fa-industry mr-2 text-accent"></i>
                                Industry
                            </label>
                            <input type="text" 
                                   id="industry" 
                                   name="industry" 
                                   class="w-full px-4 py-3 bg-accent-beige dark:bg-dark-card border border-border-light dark:border-border-dark rounded-xl focus:outline-none focus:ring-2 focus:ring-accent focus:border-accent transition-all text-text-light dark:text-text-dark"
                                   placeholder="Technology, Finance, Healthcare">
                        </div>

                        <!-- Job Title and Company -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label for="job_title" class="block text-sm font-medium text-text-light dark:text-text-dark mb-1">
                                    Job Title
                                </label>
                                <input type="text" 
                                       id="job_title" 
                                       name="job_title" 
                                       class="w-full px-4 py-3 bg-accent-beige dark:bg-dark-card border border-border-light dark:border-border-dark rounded-xl focus:outline-none focus:ring-2 focus:ring-accent focus:border-accent transition-all text-text-light dark:text-text-dark"
                                       placeholder="Senior Software Engineer">
                            </div>
                            
                            <div>
                                <label for="company" class="block text-sm font-medium text-text-light dark:text-text-dark mb-1">
                                    Company
                                </label>
                                <input type="text" 
                                       id="company" 
                                       name="company" 
                                       class="w-full px-4 py-3 bg-accent-beige dark:bg-dark-card border border-border-light dark:border-border-dark rounded-xl focus:outline-none focus:ring-2 focus:ring-accent focus:border-accent transition-all text-text-light dark:text-text-dark"
                                       placeholder="Google, Microsoft, etc.">
                            </div>
                        </div>

                        <!-- Experience Years -->
                        <div class="mb-4">
                            <label for="experience_years" class="block text-sm font-medium text-text-light dark:text-text-dark mb-1">
                                <i class="fas fa-calendar-alt mr-2 text-accent"></i>
                                Years of Experience
                            </label>
                            <div class="relative">
                                <input type="number" 
                                       id="experience_years" 
                                       name="experience_years" 
                                       min="0" 
                                       max="50"
                                       class="w-full px-4 py-3 bg-accent-beige dark:bg-dark-card border border-border-light dark:border-border-dark rounded-xl focus:outline-none focus:ring-2 focus:ring-accent focus:border-accent transition-all text-text-light dark:text-text-dark"
                                       placeholder="5">
                                <span class="absolute right-4 top-1/2 transform -translate-y-1/2 text-text-secondary-light dark:text-text-secondary-dark">
                                    years
                                </span>
                            </div>
                        </div>

                        <!-- Social Links Grid -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label for="linkedin_url" class="block text-sm font-medium text-text-light dark:text-text-dark mb-1">
                                    <i class="fab fa-linkedin mr-2 text-[#0077b5]"></i>
                                    LinkedIn URL
                                </label>
                                <input type="url" 
                                       id="linkedin_url" 
                                       name="linkedin_url" 
                                       class="w-full px-4 py-3 bg-accent-beige dark:bg-dark-card border border-border-light dark:border-border-dark rounded-xl focus:outline-none focus:ring-2 focus:ring-accent focus:border-accent transition-all text-text-light dark:text-text-dark"
                                       placeholder="https://linkedin.com/in/username">
                            </div>

                            <div>
                                <label for="github_url" class="block text-sm font-medium text-text-light dark:text-text-dark mb-1">
                                    <i class="fab fa-github mr-2 text-gray-800 dark:text-gray-300"></i>
                                    GitHub URL
                                </label>
                                <input type="url" 
                                       id="github_url" 
                                       name="github_url" 
                                       class="w-full px-4 py-3 bg-accent-beige dark:bg-dark-card border border-border-light dark:border-border-dark rounded-xl focus:outline-none focus:ring-2 focus:ring-accent focus:border-accent transition-all text-text-light dark:text-text-dark"
                                       placeholder="https://github.com/username">
                            </div>
                            
                            <div>
                                <label for="instagram_url" class="block text-sm font-medium text-text-light dark:text-text-dark mb-1">
                                    <i class="fab fa-instagram mr-2 text-[#E1306C]"></i>
                                    Instagram URL
                                </label>
                                <input type="url" 
                                       id="instagram_url" 
                                       name="instagram_url" 
                                       class="w-full px-4 py-3 bg-accent-beige dark:bg-dark-card border border-border-light dark:border-border-dark rounded-xl focus:outline-none focus:ring-2 focus:ring-accent focus:border-accent transition-all text-text-light dark:text-text-dark"
                                       placeholder="https://instagram.com/username">
                                <p class="mt-1 text-xs text-text-secondary-light dark:text-text-secondary-dark">Optional social links</p>
                            </div>

                            <div>
                                <label for="twitter_url" class="block text-sm font-medium text-text-light dark:text-text-dark mb-1">
                                    <i class="fab fa-twitter mr-2 text-[#1DA1F2]"></i>
                                    Twitter/X URL
                                </label>
                                <input type="url" 
                                       id="twitter_url" 
                                       name="twitter_url" 
                                       class="w-full px-4 py-3 bg-accent-beige dark:bg-dark-card border border-border-light dark:border-border-dark rounded-xl focus:outline-none focus:ring-2 focus:ring-accent focus:border-accent transition-all text-text-light dark:text-text-dark"
                                       placeholder="https://twitter.com/username">
                            </div>
                            
                            <div class="md:col-span-2">
                                <label for="website_url" class="block text-sm font-medium text-text-light dark:text-text-dark mb-1">
                                    <i class="fas fa-globe mr-2 text-green-600"></i>
                                    Website/Blog URL
                                </label>
                                <input type="url" 
                                       id="website_url" 
                                       name="website_url" 
                                       class="w-full px-4 py-3 bg-accent-beige dark:bg-dark-card border border-border-light dark:border-border-dark rounded-xl focus:outline-none focus:ring-2 focus:ring-accent focus:border-accent transition-all text-text-light dark:text-text-dark"
                                       placeholder="https://yourwebsite.com">
                            </div>
                        </div>
                        
                        <!-- Skills Field -->
                        <div class="mb-4">
                            <label for="skills" class="block text-sm font-medium text-text-light dark:text-text-dark mb-1">
                                <i class="fas fa-code mr-2 text-accent"></i>
                                Skills (comma separated)
                            </label>
                            <input type="text" 
                                   id="skills" 
                                   name="skills" 
                                   class="w-full px-4 py-3 bg-accent-beige dark:bg-dark-card border border-border-light dark:border-border-dark rounded-xl focus:outline-none focus:ring-2 focus:ring-accent focus:border-accent transition-all text-text-light dark:text-text-dark"
                                   placeholder="Python, React, Product Management, Data Science">
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex items-center">
                <input id="terms" name="terms" type="checkbox" required
                       class="h-4 w-4 text-accent focus:ring-accent border-border-light dark:border-border-dark rounded bg-card-light dark:bg-card-dark">
                <label for="terms" class="ml-2 block text-sm text-text-light dark:text-text-dark">
                    I agree to the
                    <a href="/terms" class="text-accent hover:text-accent/80">Terms of Service</a>
                    and
                    <a href="/privacy" class="text-accent hover:text-accent/80">Privacy Policy</a>
                </label>
            </div>

            <div>
                <button type="submit"
                        class="group relative w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-lg text-white bg-gradient-to-r from-accent to-accent/80 hover:shadow-lg hover:shadow-accent/25 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-accent transition-all transform hover:-translate-y-0.5">
                    <span class="absolute left-0 inset-y-0 flex items-center pl-3">
                        <i class="fas fa-user-plus text-white/80"></i>
                    </span>
                    Create Account
                </button>
            </div>

            <div class="text-center">
                <p class="text-sm text-text-secondary-light dark:text-text-secondary-dark">
                    Already have an account?
                    <a href="/login" class="font-medium text-accent hover:text-accent/80">
                        Sign in
                    </a>
                </p>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const learnerRadio = document.getElementById('learner');
    const mentorRadio = document.getElementById('mentor');
    const mentorFields = document.getElementById('mentor-fields');
    
    // Function to toggle mentor fields
    function toggleMentorFields() {
        if (mentorRadio.checked) {
            mentorFields.classList.remove('hidden');
            mentorFields.classList.add('block');
            // Add animation
            mentorFields.style.opacity = '0';
            mentorFields.style.transform = 'translateY(-10px)';
            
            setTimeout(() => {
                mentorFields.style.transition = 'all 0.3s ease-in-out';
                mentorFields.style.opacity = '1';
                mentorFields.style.transform = 'translateY(0)';
            }, 10);
            
            // Make mentor fields optional (not required for form submission)
            const mentorInputs = mentorFields.querySelectorAll('input, textarea');
            mentorInputs.forEach(input => {
                input.removeAttribute('required');
            });
            
        } else {
            mentorFields.style.opacity = '0';
            mentorFields.style.transform = 'translateY(-10px)';
            
            setTimeout(() => {
                mentorFields.classList.remove('block');
                mentorFields.classList.add('hidden');
            }, 300);
            
            // Clear mentor fields when switching to learner (optional)
            const clearFields = confirm('Switch to learner? This will clear all mentor information.');
            if (clearFields) {
                const mentorInputs = mentorFields.querySelectorAll('input, textarea');
                mentorInputs.forEach(input => {
                    input.value = '';
                });
            }
        }
    }
    
    // Initial check
    toggleMentorFields();
    
    // Add event listeners
    learnerRadio.addEventListener('change', toggleMentorFields);
    mentorRadio.addEventListener('change', toggleMentorFields);
    
    // Smooth scrolling to mentor fields when selected
    function scrollToMentorFields() {
        if (document.getElementById('mentor').checked) {
            const mentorFields = document.getElementById('mentor-fields');
            mentorFields.scrollIntoView({ 
                behavior: 'smooth', 
                block: 'center' 
            });
        }
    }
    
    // Add scroll event when mentor is selected
    mentorRadio.addEventListener('change', scrollToMentorFields);
});

// ================== FORM HANDLING JAVASCRIPT ==================

document.addEventListener('DOMContentLoaded', function() {
    // Initialize the form
    const form = document.querySelector('#register-form');
    
    if (!form) {
        console.error('Registration form not found!');
        return;
    }

    // Get all mentor specific fields
    const mentorFields = {
        bio: document.getElementById('bio'),
        industry: document.getElementById('industry'),
        job_title: document.getElementById('job_title'),
        company: document.getElementById('company'),
        experience_years: document.getElementById('experience_years'),
        linkedin_url: document.getElementById('linkedin_url'),
        github_url: document.getElementById('github_url'),
        instagram_url: document.getElementById('instagram_url'),
        twitter_url: document.getElementById('twitter_url'),
        website_url: document.getElementById('website_url'),
        skills: document.getElementById('skills')
    };
    
    const roleRadios = document.querySelectorAll('input[name="role"]');
    
    // Load saved data from localStorage
    loadSavedFormData();
    
    // Save mentor field data to localStorage
    Object.entries(mentorFields).forEach(([key, field]) => {
        if (field) {
            field.addEventListener('input', function() {
                localStorage.setItem(`registration_${key}`, this.value);
            });
        }
    });
    
    // Save role selection
    roleRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            localStorage.setItem('registration_role', this.value);
        });
    });
    
    // Save all form fields to localStorage
    const allFormInputs = form.querySelectorAll('input[name], textarea[name]');
    allFormInputs.forEach(input => {
        if (input.type === 'password') return;
        
        const savedValue = localStorage.getItem(`registration_${input.name}`);
        if (savedValue !== null && (!input.value || input.value.trim() === '')) {
            input.value = savedValue;
        }
        
        input.addEventListener('input', function() {
            localStorage.setItem(`registration_${this.name}`, this.value);
        });
    });
    
    // Form submission handler
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        console.log('Registration form submission started...');
        
        // Get form data
        const formData = new FormData(this);
        const role = formData.get('role');
        
        // Validate required fields
        const fullName = formData.get('full_name');
        const email = formData.get('email');
        const username = formData.get('username');
        const password = formData.get('password');
        
        // Basic validation
        if (!fullName || fullName.trim() === '') {
            showNotification('Full name is required', 'error');
            return;
        }
        
        if (!email || email.trim() === '') {
            showNotification('Email is required', 'error');
            return;
        }
        
        if (!username || username.trim() === '') {
            showNotification('Username is required', 'error');
            return;
        }
        
        if (!password) {
            showNotification('Password is required', 'error');
            return;
        }
        
        if (!role) {
            showNotification('Please select a role', 'error');
            return;
        }
        
        // Validate password strength (optional)
        if (password.length < 8) {
            showNotification('Password must be at least 8 characters long', 'warning');
            return;
        }
        
        // Validate URLs if provided
        const linkedinUrl = formData.get('linkedin_url');
        if (linkedinUrl && !isValidUrl(linkedinUrl)) {
            showNotification('Please enter a valid LinkedIn URL', 'warning');
            mentorFields.linkedin_url.focus();
            return;
        }
        
        const githubUrl = formData.get('github_url');
        if (githubUrl && !isValidUrl(githubUrl)) {
            showNotification('Please enter a valid GitHub URL', 'warning');
            mentorFields.github_url.focus();
            return;
        }
        
        const instagramUrl = formData.get('instagram_url');
        if (instagramUrl && !isValidUrl(instagramUrl)) {
            showNotification('Please enter a valid Instagram URL', 'warning');
            mentorFields.instagram_url.focus();
            return;
        }
        
        const twitterUrl = formData.get('twitter_url');
        if (twitterUrl && !isValidUrl(twitterUrl)) {
            showNotification('Please enter a valid Twitter URL', 'warning');
            mentorFields.twitter_url.focus();
            return;
        }
        
        const websiteUrl = formData.get('website_url');
        if (websiteUrl && !isValidUrl(websiteUrl)) {
            showNotification('Please enter a valid Website URL', 'warning');
            mentorFields.website_url.focus();
            return;
        }
        
        // Validate experience years
        const experienceYears = formData.get('experience_years');
        if (experienceYears) {
            const expNum = parseInt(experienceYears);
            if (isNaN(expNum) || expNum < 0 || expNum > 50) {
                showNotification('Experience years must be between 0 and 50', 'warning');
                mentorFields.experience_years.focus();
                return;
            }
        }
        
        // Show loading state
        const submitBtn = form.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Creating Account...';
        submitBtn.disabled = true;
        
        try {
            // Submit form via AJAX
            const response = await fetch('/register', {
                method: 'POST',
                body: formData
            });
            
            // Check if response is a redirect
            if (response.redirected) {
                // Clear localStorage on successful submission
                clearRegistrationLocalStorage();
                
                // Get the redirect URL
                const redirectUrl = response.url;
                
                // Show success message
                showNotification('Account created successfully! Redirecting...', 'success');
                
                // Redirect to login or dashboard
                setTimeout(() => {
                    window.location.href = redirectUrl;
                }, 1500);
                
                return;
            }
            
            // Try to parse as JSON (for API errors)
            try {
                const data = await response.json();
                
                if (data.success) {
                    // Clear localStorage on successful registration
                    clearRegistrationLocalStorage();
                    
                    showNotification(data.message || 'Account created successfully!', 'success');
                    
                    // Redirect after success
                    setTimeout(() => {
                        if (data.redirect_url) {
                            window.location.href = data.redirect_url;
                        } else {
                            window.location.href = '/login';
                        }
                    }, 1500);
                } else {
                    throw new Error(data.message || 'Failed to create account');
                }
            } catch (jsonError) {
                // If response is HTML and not JSON, check for errors in response text
                const responseText = await response.text();
                
                if (responseText.includes('already registered') || responseText.includes('already exists')) {
                    showNotification('Email or username already registered', 'error');
                } else if (!response.ok) {
                    showNotification('Registration failed. Please try again.', 'error');
                } else {
                    // Assume success if response is OK
                    clearRegistrationLocalStorage();
                    showNotification('Account created successfully!', 'success');
                    setTimeout(() => {
                        window.location.href = '/login';
                    }, 1500);
                }
            }
            
        } catch (error) {
            console.error('Registration error:', error);
            showNotification('Error: ' + error.message, 'error');
            
            // Reset button
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    });
    
    // URL validation helper
    function isValidUrl(string) {
        if (!string || string.trim() === '') return true; // Empty is OK
        try {
            const url = new URL(string);
            return url.protocol === 'http:' || url.protocol === 'https:';
        } catch (_) {
            return false;
        }
    }
    
    // Add validation styling to URL fields
    Object.entries(mentorFields).forEach(([key, field]) => {
        if (field && (key.includes('_url') || key === 'github_url')) {
            field.addEventListener('blur', function() {
                const value = this.value.trim();
                if (value && !isValidUrl(value)) {
                    this.classList.add('border-red-500', 'bg-red-50');
                } else {
                    this.classList.remove('border-red-500', 'bg-red-50');
                }
            });
        }
    });
    
    // Functions
    
    function loadSavedFormData() {
        // Load saved role
        const savedRole = localStorage.getItem('registration_role');
        if (savedRole) {
            const roleRadio = document.querySelector(`input[name="role"][value="${savedRole}"]`);
            if (roleRadio) {
                roleRadio.checked = true;
                // Trigger change event to show/hide mentor fields
                roleRadio.dispatchEvent(new Event('change'));
            }
        }
        
        // Load saved mentor fields
        Object.entries(mentorFields).forEach(([key, field]) => {
            if (field) {
                const savedValue = localStorage.getItem(`registration_${key}`);
                if (savedValue !== null) {
                    field.value = savedValue;
                }
            }
        });
        
        // Load basic fields
        const basicFields = ['full_name', 'email', 'username'];
        basicFields.forEach(fieldName => {
            const field = document.querySelector(`[name="${fieldName}"]`);
            if (field) {
                const savedValue = localStorage.getItem(`registration_${fieldName}`);
                if (savedValue !== null) {
                    field.value = savedValue;
                }
            }
        });
    }
    
    function clearRegistrationLocalStorage() {
        // Clear all registration-related keys
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key && key.startsWith('registration_')) {
                localStorage.removeItem(key);
            }
        }
    }
    
    // Notification function
    function showNotification(message, type = 'info') {
        // Remove any existing notifications
        const existingNotifications = document.querySelectorAll('.notification-toast');
        existingNotifications.forEach(n => n.remove());
        
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `notification-toast fixed top-4 right-4 z-50 p-4 rounded-xl shadow-lg transform transition-all duration-300 translate-x-0 ${
            type === 'success' ? 'bg-green-500 text-white border border-green-600' :
            type === 'error' ? 'bg-red-500 text-white border border-red-600' :
            type === 'warning' ? 'bg-yellow-500 text-white border border-yellow-600' :
            'bg-blue-500 text-white border border-blue-600'
        }`;
        
        notification.innerHTML = `
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle'} mr-3"></i>
                    <span class="font-medium">${message}</span>
                </div>
                <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white opacity-80 hover:opacity-100">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
        
        document.body.appendChild(notification);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            notification.style.opacity = '0';
            notification.style.transform = 'translateX(100%)';
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 300);
        }, 5000);
    }
    
    // Enhance form inputs with focus effects
    document.querySelectorAll('input, textarea, select').forEach(input => {
        const parent = input.closest('div');
        if (!parent) return;
        
        input.addEventListener('focus', function() {
            parent.classList.add('ring-2', 'ring-accent/20');
        });
        
        input.addEventListener('blur', function() {
            parent.classList.remove('ring-2', 'ring-accent/20');
        });
    });
    
    // Make functions available globally
    window.showNotification = showNotification;
    window.clearRegistrationLocalStorage = clearRegistrationLocalStorage;
});

</script>
<!-- CSS Styling -->
<style>
    /* Radio button styling */
    input[type="radio"]:checked + label {
        border-color: var(--accent);
        background-color: rgba(255, 107, 74, 0.05);
    }
    
    /* Animation for mentor fields */
    #mentor-fields {
        overflow: hidden;
        max-height: 0;
        opacity: 0;
        transition: max-height 0.5s ease-in-out, opacity 0.5s ease-in-out;
    }
    
    #mentor-fields.block {
        max-height: 1000px;
        opacity: 1;
    }
    
    /* Improve form focus states */
    textarea:focus, input[type="url"]:focus, input[type="text"]:focus, input[type="email"]:focus, input[type="number"]:focus {
        outline: none;
        ring: 2px;
        ring-color: var(--accent);
        border-color: var(--accent);
        box-shadow: 0 0 0 3px rgba(255, 107, 74, 0.1);
    }
    
    /* Style for the industry icon */
    .fa-industry {
        display: inline-block;
        width: 16px;
        text-align: center;
    }
    
    /* Notification toast styling */
    .notification-toast {
        animation: slideIn 0.3s ease-out;
    }
    
    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    /* Validation styles */
    .border-red-500 {
        border-color: #ef4444 !important;
    }
    
    .bg-red-50 {
        background-color: #fef2f2 !important;
    }
    
    /* Loading spinner animation */
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .fa-spinner {
        animation: spin 1s linear infinite;
    }
    
    /* Form input focus effects */
    input:focus, textarea:focus, select:focus {
        box-shadow: 0 0 0 3px rgba(255, 107, 74, 0.1);
        border-color: var(--accent) !important;
    }
    
    /* Responsive adjustments */
    @media (max-width: 640px) {
        .grid-cols-2 {
            grid-template-columns: 1fr;
            gap: 0.75rem;
        }
        
        #mentor-fields {
            padding-top: 1rem;
        }
        
        .grid-cols-1.md\:grid-cols-2 {
            grid-template-columns: 1fr;
            gap: 0.75rem;
        }
        
        .notification-toast {
            top: auto;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) !important;
            right: auto;
            min-width: 90%;
            max-width: 400px;
        }
    }
    
    /* Mobile Header Fix */
    @media (max-width: 768px) {
        .min-h-screen {
            padding-top: 2rem;
            padding-bottom: 2rem;
        }
    }
    
    /* Form field spacing */
    .space-y-4 > div {
        margin-bottom: 1rem;
    }
    
    /* Dark mode adjustments for form */
    .dark input, .dark textarea, .dark select {
        background-color: var(--card-dark);
        border-color: var(--border-dark);
        color: var(--text-dark);
    }
    
    .dark input:focus, .dark textarea:focus, .dark select:focus {
        border-color: var(--accent);
        box-shadow: 0 0 0 3px rgba(255, 107, 74, 0.2);
    }
    
    .dark input::placeholder, .dark textarea::placeholder {
        color: var(--text-secondary-dark);
    }
    
    /* Ensure mentor fields have proper spacing in dark mode */
    .dark .bg-accent-beige {
        background-color: var(--dark-card);
    }
    
    /* Style for required field asterisk */
    label:has(+ input[required])::after,
    label:has(+ textarea[required])::after {
        content: " *";
        color: #ef4444;
    }
</style>
{% endblock %}
