{% extends "base.html" %}

{% block title %}Withdraw Funds - ClearQ{% endblock %}

{% block content %}
<style>
    :root {
        --primary: #3B82F6;
        --primary-dark: #2563EB;
        --success: #10B981;
        --warning: #F59E0B;
        --danger: #EF4444;
        --gray-900: #0F172A;
        --gray-800: #1E293B;
        --gray-700: #334155;
        --gray-600: #475569;
        --gray-500: #64748B;
        --gray-400: #94A3B8;
        --gray-300: #CBD5E1;
        --gray-200: #E2E8F0;
        --gray-100: #F1F5F9;
        --gray-50: #F8FAFC;
        --white: #FFFFFF;
    }

    .withdraw-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 1rem;
    }

    /* Balance Summary */
    .balance-summary {
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        color: white;
        border-radius: 1rem;
        padding: 2rem;
        margin-bottom: 2rem;
        position: relative;
        overflow: hidden;
    }

    .balance-summary::before {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        width: 200px;
        height: 200px;
        background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
        border-radius: 50%;
    }

    .balance-amount {
        font-size: 3rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
        position: relative;
        z-index: 1;
    }

    .balance-label {
        font-size: 1rem;
        opacity: 0.9;
        position: relative;
        z-index: 1;
    }

    /* Main Content Grid */
    .withdraw-content {
        display: grid;
        grid-template-columns: 1fr;
        gap: 2rem;
    }

    @media (min-width: 768px) {
        .withdraw-content {
            grid-template-columns: 1fr 1fr;
        }
    }

    /* Withdrawal Form */
    .withdraw-form-container {
        background: var(--white);
        border-radius: 1rem;
        padding: 2rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        border: 1px solid var(--gray-200);
    }

    .form-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--gray-900);
        margin-bottom: 1.5rem;
    }

    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-label {
        display: block;
        font-size: 0.875rem;
        font-weight: 500;
        color: var(--gray-700);
        margin-bottom: 0.5rem;
    }

    .form-input {
        width: 100%;
        padding: 0.75rem 1rem;
        border: 1px solid var(--gray-300);
        border-radius: 0.5rem;
        font-size: 1rem;
        color: var(--gray-900);
        transition: border-color 0.2s;
    }

    .form-input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .form-textarea {
        width: 100%;
        padding: 0.75rem 1rem;
        border: 1px solid var(--gray-300);
        border-radius: 0.5rem;
        font-size: 0.875rem;
        color: var(--gray-900);
        resize: vertical;
        min-height: 100px;
    }

    .form-textarea:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .amount-input-container {
        position: relative;
    }

    .amount-prefix {
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        font-size: 1rem;
        color: var(--gray-500);
    }

    .amount-input {
        padding-left: 2.5rem;
    }

    .amount-hint {
        display: block;
        font-size: 0.75rem;
        color: var(--gray-500);
        margin-top: 0.25rem;
    }

    .form-select {
        width: 100%;
        padding: 0.75rem 1rem;
        border: 1px solid var(--gray-300);
        border-radius: 0.5rem;
        font-size: 1rem;
        color: var(--gray-900);
        background: var(--white);
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2364748B'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 1rem center;
        background-size: 1rem;
    }

    .form-select:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .submit-button {
        width: 100%;
        padding: 1rem;
        background: linear-gradient(135deg, var(--primary), var(--primary-dark));
        color: white;
        border: none;
        border-radius: 0.5rem;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        margin-top: 1rem;
    }

    .submit-button:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.3);
    }

    .submit-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* Withdrawal History */
    .history-container {
        background: var(--white);
        border-radius: 1rem;
        padding: 2rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        border: 1px solid var(--gray-200);
    }

    .history-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--gray-900);
        margin-bottom: 1.5rem;
    }

    .history-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .history-item {
        padding: 1rem;
        border: 1px solid var(--gray-200);
        border-radius: 0.5rem;
        background: var(--gray-50);
        transition: all 0.2s;
    }

    .history-item:hover {
        background: var(--white);
        border-color: var(--gray-300);
        transform: translateY(-2px);
    }

    .history-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }

    .history-amount {
        font-size: 1.125rem;
        font-weight: 700;
        color: var(--gray-900);
    }

    .history-date {
        font-size: 0.875rem;
        color: var(--gray-500);
    }

    .history-status {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 500;
        text-transform: capitalize;
    }

    .status-pending { background: #FEF3C7; color: #92400E; }
    .status-processing { background: #DBEAFE; color: #1E40AF; }
    .status-approved { background: #D1FAE5; color: #065F46; }
    .status-completed { background: #D1FAE5; color: #065F46; }
    .status-rejected { background: #FEE2E2; color: #991B1B; }

    .history-details {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 0.5rem;
        padding-top: 0.5rem;
        border-top: 1px solid var(--gray-200);
    }

    .history-method {
        font-size: 0.875rem;
        color: var(--gray-600);
    }

    .empty-history {
        text-align: center;
        padding: 3rem 1rem;
        color: var(--gray-500);
    }

    .empty-history i {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }

    /* Info Box */
    .info-box {
        background: linear-gradient(135deg, #F0FDF4, #DCFCE7);
        border: 1px solid #BBF7D0;
        border-radius: 0.75rem;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }

    .info-title {
        font-size: 1rem;
        font-weight: 600;
        color: #065F46;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .info-content {
        font-size: 0.875rem;
        color: #065F46;
        opacity: 0.9;
        line-height: 1.5;
    }

    /* Recent Earnings */
    .earnings-summary {
        background: linear-gradient(135deg, #EFF6FF, #DBEAFE);
        border: 1px solid #DBEAFE;
        border-radius: 0.75rem;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }

    .earnings-title {
        font-size: 1rem;
        font-weight: 600;
        color: #1E40AF;
        margin-bottom: 0.5rem;
    }

    .earnings-amount {
        font-size: 1.5rem;
        font-weight: 700;
        color: #1E40AF;
        margin-bottom: 0.5rem;
    }

    .earnings-period {
        font-size: 0.875rem;
        color: #1E40AF;
        opacity: 0.8;
    }

    /* Modal */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
    }

    .modal-content {
        background-color: var(--white);
        margin: 10% auto;
        padding: 2rem;
        border-radius: 1rem;
        width: 90%;
        max-width: 500px;
        position: relative;
        animation: modalSlideIn 0.3s ease-out;
    }

    @keyframes modalSlideIn {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }

    .modal-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--gray-900);
    }

    .close-button {
        background: none;
        border: none;
        font-size: 1.5rem;
        color: var(--gray-500);
        cursor: pointer;
        padding: 0.25rem;
    }

    .close-button:hover {
        color: var(--gray-700);
    }

    .modal-body {
        margin-bottom: 1.5rem;
    }

    .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
    }

    .modal-button {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }

    .modal-button.confirm {
        background: linear-gradient(135deg, var(--primary), var(--primary-dark));
        color: white;
    }

    .modal-button.confirm:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.3);
    }

    .modal-button.cancel {
        background: var(--gray-100);
        color: var(--gray-700);
        border: 1px solid var(--gray-300);
    }

    .modal-button.cancel:hover {
        background: var(--gray-200);
    }
</style>

<div class="withdraw-container">
    <!-- Balance Summary -->
    <div class="balance-summary">
        <div class="balance-amount">₹{{ "%.2f"|format(available_balance) }}</div>
        <div class="balance-label">Available for Withdrawal</div>
    </div>

    <!-- Info Box -->
    <div class="info-box">
        <div class="info-title">
            <i class="fas fa-info-circle"></i>
            Withdrawal Information
        </div>
        <div class="info-content">
            • Minimum withdrawal amount: ₹500<br>
            • Withdrawal requests are processed within 3-5 business days<br>
            • You'll receive payment via your selected method<br>
            • All withdrawals are subject to platform terms
        </div>
    </div>

    <!-- Recent Earnings -->
    <div class="earnings-summary">
        <div class="earnings-title">Recent Earnings (30 days)</div>
        <div class="earnings-amount">₹{{ recent_earnings }}</div>
        <div class="earnings-period">Earnings from completed sessions</div>
    </div>

    <!-- Main Content -->
    <div class="withdraw-content">
        <!-- Withdrawal Form -->
        <div class="withdraw-form-container">
            <h2 class="form-title">Request Withdrawal</h2>
            
            <form id="withdrawalForm">
                <div class="form-group">
                    <label for="amount" class="form-label">Amount (₹)</label>
                    <div class="amount-input-container">
                        <span class="amount-prefix">₹</span>
                        <input 
                            type="number" 
                            id="amount" 
                            name="amount"
                            class="form-input amount-input"
                            placeholder="Enter amount"
                            min="500"
                            max="{{ "%.2f"|format(available_balance) }}"
                            step="0.01"
                            required
                        >
                    </div>
                    <small class="amount-hint">
                        Available: ₹{{ "%.2f"|format(available_balance) }} | Min: ₹500
                    </small>
                </div>

                <div class="form-group">
                    <label for="payment_method" class="form-label">Payment Method</label>
                    <select id="payment_method" name="payment_method" class="form-select" required>
                        <option value="">Select payment method</option>
                        <option value="bank_transfer">Bank Transfer</option>
                        <option value="upi">UPI</option>
                        <option value="paypal">PayPal</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="account_details" class="form-label">Account Details</label>
                    <textarea 
                        id="account_details" 
                        name="account_details"
                        class="form-textarea"
                        placeholder="Enter your account details. For bank transfer: Account number, IFSC code, Account holder name. For UPI: UPI ID."
                        required
                    ></textarea>
                </div>

                <div class="form-group">
                    <label for="notes" class="form-label">Notes (Optional)</label>
                    <input 
                        type="text" 
                        id="notes" 
                        name="notes"
                        class="form-input"
                        placeholder="Any additional notes for the admin"
                    >
                </div>

                <button type="submit" class="submit-button" id="submitButton">
                    <i class="fas fa-paper-plane mr-2"></i>
                    Submit Withdrawal Request
                </button>
            </form>
        </div>

        <!-- Withdrawal History -->
        <div class="history-container">
            <h2 class="history-title">Recent Withdrawals</h2>
            
            {% if withdrawals and withdrawals|length > 0 %}
            <div class="history-list">
                {% for withdrawal in withdrawals %}
                <div class="history-item">
                    <div class="history-header">
                        <div class="history-amount">₹{{ "%.2f"|format(withdrawal.amount) }}</div>
                        <span class="history-status status-{{ withdrawal.status }}">
                            {{ withdrawal.status }}
                        </span>
                    </div>
                    <div class="history-date">
                        Requested: {{ withdrawal.requested_at.strftime('%d %b %Y, %I:%M %p') }}
                    </div>
                    {% if withdrawal.processed_at %}
                    <div class="history-date" style="margin-top: 0.25rem;">
                        Processed: {{ withdrawal.processed_at.strftime('%d %b %Y, %I:%M %p') }}
                    </div>
                    {% endif %}
                    <div class="history-details">
                        <div class="history-method">
                            <i class="fas fa-{{ 'university' if withdrawal.payment_method == 'bank_transfer' else 'mobile-alt' }} mr-1"></i>
                            {{ withdrawal.payment_method|replace('_', ' ')|title }}
                        </div>
                        {% if withdrawal.notes %}
                        <div class="history-method" title="{{ withdrawal.notes }}">
                            <i class="fas fa-sticky-note mr-1"></i>
                            Has notes
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-history">
                <i class="fas fa-history"></i>
                <p>No withdrawal history yet</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div id="confirmationModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Confirm Withdrawal</h3>
            <button class="close-button" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body">
            <p>Are you sure you want to submit a withdrawal request for <strong id="modalAmount">₹0</strong>?</p>
            <p>This request will be sent to the admin for processing.</p>
        </div>
        <div class="modal-footer">
            <button class="modal-button cancel" onclick="closeModal()">Cancel</button>
            <button class="modal-button confirm" onclick="confirmWithdrawal()">Confirm</button>
        </div>
    </div>
</div>

<!-- Success Modal -->
<div id="successModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Request Submitted</h3>
            <button class="close-button" onclick="closeSuccessModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div style="text-align: center; margin: 2rem 0;">
                <i class="fas fa-check-circle" style="font-size: 4rem; color: var(--success);"></i>
                <h3 style="margin: 1rem 0; color: var(--gray-900);">Withdrawal Request Submitted!</h3>
                <p style="color: var(--gray-600);">
                    Your withdrawal request has been submitted successfully.<br>
                    You will receive payment within 3-5 business days.
                </p>
            </div>
        </div>
        <div class="modal-footer">
            <button class="modal-button confirm" onclick="closeSuccessModal()">OK</button>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('withdrawalForm');
        const amountInput = document.getElementById('amount');
        const paymentMethodSelect = document.getElementById('payment_method');
        const accountDetailsTextarea = document.getElementById('account_details');
        const submitButton = document.getElementById('submitButton');
        const availableBalance = {{ available_balance }};
        const minAmount = 500;

        // Set max amount
        amountInput.max = availableBalance;

        // Validate amount on input
        amountInput.addEventListener('input', function() {
            const amount = parseFloat(this.value);
            
            if (amount < minAmount) {
                this.setCustomValidity(`Minimum withdrawal amount is ₹${minAmount}`);
            } else if (amount > availableBalance) {
                this.setCustomValidity(`Amount cannot exceed available balance of ₹${availableBalance}`);
            } else {
                this.setCustomValidity('');
            }
        });

        // Form submission
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const amount = parseFloat(amountInput.value);
            const paymentMethod = paymentMethodSelect.value;
            const accountDetails = accountDetailsTextarea.value.trim();
            
            // Validate
            if (!amount || amount < minAmount || amount > availableBalance) {
                alert(`Please enter a valid amount between ₹${minAmount} and ₹${availableBalance}`);
                return;
            }
            
            if (!paymentMethod) {
                alert('Please select a payment method');
                return;
            }
            
            if (!accountDetails) {
                alert('Please enter your account details');
                return;
            }
            
            // Show confirmation modal
            document.getElementById('modalAmount').textContent = `₹${amount.toFixed(2)}`;
            document.getElementById('confirmationModal').style.display = 'block';
        });
    });

    let withdrawalData = null;

    function confirmWithdrawal() {
        const amount = document.getElementById('amount').value;
        const paymentMethod = document.getElementById('payment_method').value;
        const accountDetails = document.getElementById('account_details').value;
        const notes = document.getElementById('notes').value;
        
        withdrawalData = {
            amount: amount,
            payment_method: paymentMethod,
            account_details: accountDetails,
            notes: notes
        };
        
        // Submit the request
        submitWithdrawalRequest();
    }

    async function submitWithdrawalRequest() {
        const submitButton = document.querySelector('.modal-button.confirm');
        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Processing...';
        submitButton.disabled = true;
        
        try {
            const response = await fetch('/api/mentor/withdraw/request', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(withdrawalData)
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Close confirmation modal
                closeModal();
                
                // Show success modal
                document.getElementById('successModal').style.display = 'block';
                
                // Reset form
                document.getElementById('withdrawalForm').reset();
                
                // Redirect after 3 seconds
                setTimeout(() => {
                    if (data.redirect_url) {
                        window.location.href = data.redirect_url;
                    } else {
                        location.reload();
                    }
                }, 3000);
            } else {
                alert('Error: ' + data.message);
                submitButton.innerHTML = 'Confirm';
                submitButton.disabled = false;
            }
        } catch (error) {
            alert('An error occurred. Please try again.');
            submitButton.innerHTML = 'Confirm';
            submitButton.disabled = false;
        }
    }

    function closeModal() {
        document.getElementById('confirmationModal').style.display = 'none';
    }

    function closeSuccessModal() {
        document.getElementById('successModal').style.display = 'none';
        location.reload();
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
        const modal = document.getElementById('confirmationModal');
        const successModal = document.getElementById('successModal');
        
        if (event.target === modal) {
            modal.style.display = 'none';
        }
        if (event.target === successModal) {
            successModal.style.display = 'none';
        }
    }
</script>
{% endblock %}
