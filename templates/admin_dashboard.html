@app.get("/admin/dashboard", response_class=HTMLResponse)
async def admin_dashboard(
    request: Request,
    current_user = Depends(get_current_user),
    db: Session = Depends(get_db)
):
    if not current_user or current_user.role != "admin":
        raise HTTPException(status_code=403, detail="Access denied")
    
    # Pending mentor verifications
    pending_mentors = db.query(Mentor).filter(
        Mentor.verification_status == "pending"
    ).join(User).all()
    
    # Get recent users (last 10)
    recent_users = db.query(User).order_by(
        User.created_at.desc()
    ).limit(10).all()
    
    # Get all recent bookings (last 20)
    recent_bookings = db.query(Booking).order_by(
        Booking.created_at.desc()
    ).limit(20).all()
    
    # Get recent digital product sales
    recent_digital_sales = db.query(Booking).filter(
        Booking.service.has(is_digital=True),
        Booking.payment_status == "paid"
    ).order_by(Booking.created_at.desc()).limit(10).all()
    
    # Calculate admin stats
    total_users = db.query(User).count()
    total_mentors = db.query(Mentor).filter(
        Mentor.is_verified_by_admin == True
    ).count()
    total_bookings = db.query(Booking).count()
    total_digital_sales = db.query(Booking).filter(
        Booking.service.has(is_digital=True),
        Booking.payment_status == "paid"
    ).count()
    
    # Calculate revenue
    total_revenue = db.query(Booking).filter(
        Booking.payment_status == "paid"
    ).with_entities(func.sum(Booking.amount_paid)).scalar() or 0
    
    digital_revenue = db.query(Booking).filter(
        Booking.service.has(is_digital=True),
        Booking.payment_status == "paid"
    ).with_entities(func.sum(Booking.amount_paid)).scalar() or 0
    
    session_revenue = total_revenue - digital_revenue
    
    # Get pending bookings count
    pending_bookings_count = db.query(Booking).filter(
        Booking.payment_status == "pending"
    ).count()
    
    # Get today's stats
    today = datetime.now().date()
    today_bookings = db.query(Booking).filter(
        func.date(Booking.created_at) == today
    ).count()
    
    today_revenue = db.query(Booking).filter(
        func.date(Booking.created_at) == today,
        Booking.payment_status == "paid"
    ).with_entities(func.sum(Booking.amount_paid)).scalar() or 0
    
    context = {
        "request": request,
        "current_user": current_user,
        "pending_mentors": pending_mentors,
        "recent_users": recent_users,
        "recent_bookings": recent_bookings,
        "recent_digital_sales": recent_digital_sales,
        "stats": {
            "total_users": total_users,
            "total_mentors": total_mentors,
            "total_bookings": total_bookings,
            "total_digital_sales": total_digital_sales,
            "total_revenue": total_revenue,
            "digital_revenue": digital_revenue,
            "session_revenue": session_revenue,
            "pending_bookings": pending_bookings_count,
            "today_bookings": today_bookings,
            "today_revenue": today_revenue
        }
    }
    
    return templates.TemplateResponse("admin_dashboard.html", context)
