{% extends "base.html" %}

{% block title %}Manage Availability - ClearQ{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Header -->
        <div class="mb-8">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">Manage Availability</h1>
                    <p class="text-gray-600 mt-2">Set your regular weekly schedule</p>
                </div>
                <a href="/dashboard" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200">
                    <i class="fas fa-arrow-left mr-2"></i> Back to Dashboard
                </a>
            </div>
        </div>

        <!-- Flash Messages -->
        {% if flash_messages %}
        <div class="mb-6 space-y-3">
            {% for message in flash_messages %}
            <div class="rounded-xl border-l-4 {% if message.category == 'success' %}border-green-500 bg-green-50{% elif message.category == 'error' %}border-red-500 bg-red-50{% else %}border-blue-500 bg-blue-50{% endif %} p-4">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas {% if message.category == 'success' %}fa-check-circle text-green-400{% elif message.category == 'error' %}fa-exclamation-circle text-red-400{% else %}fa-info-circle text-blue-400{% endif %}"></i>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm font-medium {% if message.category == 'success' %}text-green-800{% elif message.category == 'error' %}text-red-800{% else %}text-blue-800{% endif %}">
                            {{ message.message }}
                        </p>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Main Content -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left Column - Weekly Schedule -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-2xl shadow-lg border border-gray-100 p-6 mb-8">
                    <h2 class="text-xl font-bold text-gray-900 mb-6">Weekly Schedule</h2>
                    <p class="text-gray-600 mb-6">Select the days you're available each week. You can set different hours for each day.</p>
                    
                    <div id="days-container" class="space-y-4">
                        {% for day in [
                            {"id": 0, "name": "Monday"},
                            {"id": 1, "name": "Tuesday"},
                            {"id": 2, "name": "Wednesday"},
                            {"id": 3, "name": "Thursday"},
                            {"id": 4, "name": "Friday"},
                            {"id": 5, "name": "Saturday"},
                            {"id": 6, "name": "Sunday"}
                        ] %}
                        <div class="border border-gray-200 rounded-lg p-4 transition-all duration-200 hover:border-blue-300" id="day-{{ day.id }}-container">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <input type="checkbox" 
                                           id="day-{{ day.id }}" 
                                           data-day-id="{{ day.id }}"
                                           class="day-checkbox h-5 w-5 text-blue-600 rounded focus:ring-blue-500"
                                           {% if day.id < 7 %}checked{% endif %}>
                                    <label for="day-{{ day.id }}" class="ml-3 text-lg font-medium text-gray-900 cursor-pointer">
                                        {{ day.name }}
                                    </label>
                                </div>
                                <div class="flex items-center space-x-4" id="time-controls-{{ day.id }}">
                                    <div>
                                        <label class="block text-sm text-gray-600">Start</label>
                                        <input type="time" 
                                               id="start-{{ day.id }}"
                                               data-day-id="{{ day.id }}"
                                               value="09:00"
                                               class="time-input mt-1 border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    </div>
                                    <div>
                                        <label class="block text-sm text-gray-600">End</label>
                                        <input type="time" 
                                               id="end-{{ day.id }}"
                                               data-day-id="{{ day.id }}"
                                               value="21:00"
                                               class="time-input mt-1 border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    </div>
                                </div>
                            </div>
                            <div class="mt-3 pt-3 border-t border-gray-100 hidden" id="preview-{{ day.id }}">
                                <p class="text-sm text-gray-600">
                                    <i class="fas fa-clock mr-2"></i>
                                    Available: <span id="time-display-{{ day.id }}">9:00 AM - 9:00 PM</span>
                                </p>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <div class="mt-8 pt-6 border-t border-gray-200">
                        <div class="flex items-center space-x-4">
                            <button onclick="saveAvailability()" 
                                    id="save-btn"
                                    class="px-6 py-3 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition-colors">
                                <i class="fas fa-save mr-2"></i> Save Schedule
                            </button>
                            <button onclick="resetToDefault()" class="px-4 py-3 border border-gray-300 text-gray-700 font-medium rounded-lg hover:bg-gray-50">
                                <i class="fas fa-undo mr-2"></i> Reset to Default
                            </button>
                        </div>
                        <p class="mt-3 text-sm text-gray-500">
                            <i class="fas fa-info-circle mr-1"></i>
                            Your schedule will automatically generate available slots for the next 30 days
                        </p>
                    </div>
                </div>

                <!-- Special Dates (Exceptions) -->
                <div class="bg-white rounded-2xl shadow-lg border border-gray-100 p-6">
                    <h2 class="text-xl font-bold text-gray-900 mb-6">Special Dates</h2>
                    <p class="text-gray-600 mb-6">Mark specific dates as unavailable (holidays, vacations, etc.)</p>
                    
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Add Unavailable Date</label>
                        <div class="flex flex-col sm:flex-row gap-3">
                            <input type="date" 
                                   id="exception-date" 
                                   min="{{ today }}" 
                                   class="flex-1 border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <input type="text" 
                                   id="exception-reason" 
                                   placeholder="Reason (optional)" 
                                   class="flex-1 border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <button onclick="addException()" 
                                    class="bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700 font-medium whitespace-nowrap">
                                <i class="fas fa-ban mr-2"></i> Mark Unavailable
                            </button>
                        </div>
                    </div>
                    
                    <div id="exceptions-list">
                        <div class="text-center py-8">
                            <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-gray-100 flex items-center justify-center">
                                <i class="fas fa-calendar text-gray-400 text-2xl"></i>
                            </div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-2">No Special Dates</h3>
                            <p class="text-gray-500">Add dates when you're not available despite your weekly schedule</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column - Information & Tools -->
            <div class="space-y-8">
                <!-- Information Card -->
                <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-2xl shadow-lg border border-blue-200 p-6">
                    <h3 class="text-lg font-bold text-gray-900 mb-4">How It Works</h3>
                    <ul class="space-y-3">
                        <li class="flex items-start">
                            <i class="fas fa-check-circle text-green-500 mt-1 mr-3"></i>
                            <span class="text-sm text-gray-700">Check the days you're regularly available</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-check-circle text-green-500 mt-1 mr-3"></i>
                            <span class="text-sm text-gray-700">Set time ranges for each day</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-check-circle text-green-500 mt-1 mr-3"></i>
                            <span class="text-sm text-gray-700">System generates slots for next 30 days</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-check-circle text-green-500 mt-1 mr-3"></i>
                            <span class="text-sm text-gray-700">Mark special dates as unavailable</span>
                        </li>
                    </ul>
                    
                    <div class="mt-6 pt-4 border-t border-blue-200">
                        <h4 class="font-medium text-gray-900 mb-3">Quick Time Presets:</h4>
                        <div class="grid grid-cols-1 gap-2">
                            <button onclick="setTimePreset('9:00', '21:00')" 
                                    class="w-full text-left text-sm text-gray-700 hover:bg-white p-3 rounded-lg border border-blue-200 hover:border-blue-400 transition-colors">
                                <i class="fas fa-briefcase mr-2 text-blue-500"></i>
                                Full Day (9 AM - 9 PM)
                            </button>
                            <button onclick="setTimePreset('17:00', '21:00')" 
                                    class="w-full text-left text-sm text-gray-700 hover:bg-white p-3 rounded-lg border border-blue-200 hover:border-blue-400 transition-colors">
                                <i class="fas fa-moon mr-2 text-purple-500"></i>
                                Evening (5 PM - 9 PM)
                            </button>
                            <button onclick="setTimePreset('10:00', '14:00')" 
                                    class="w-full text-left text-sm text-gray-700 hover:bg-white p-3 rounded-lg border border-blue-200 hover:border-blue-400 transition-colors">
                                <i class="fas fa-sun mr-2 text-yellow-500"></i>
                                Midday (10 AM - 2 PM)
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Preview Card -->
                <div class="bg-gradient-to-br from-green-50 to-emerald-100 rounded-2xl shadow-lg border border-green-200 p-6">
                    <h3 class="text-lg font-bold text-gray-900 mb-4">Your Schedule Preview</h3>
                    <div id="schedule-preview" class="space-y-3">
                        <!-- Preview will be generated here -->
                    </div>
                    <div class="mt-6 pt-4 border-t border-green-200">
                        <div class="text-sm text-gray-600">
                            <p class="mb-2"><strong>Next Available Dates:</strong></p>
                            <div id="next-dates" class="text-green-700 font-medium">
                                <!-- Dates will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tools Card -->
                <div class="bg-gradient-to-br from-yellow-50 to-orange-100 rounded-2xl shadow-lg border border-yellow-200 p-6">
                    <h3 class="text-lg font-bold text-gray-900 mb-4">Quick Actions</h3>
                    <div class="space-y-3">
                        <button onclick="selectWeekdays()" 
                                class="w-full flex items-center justify-between p-3 bg-white rounded-lg border border-yellow-200 hover:border-yellow-400 transition-colors">
                            <div class="flex items-center">
                                <div class="w-8 h-8 rounded-lg bg-blue-100 flex items-center justify-center mr-3">
                                    <i class="fas fa-calendar-week text-blue-600"></i>
                                </div>
                                <div>
                                    <span class="font-medium text-gray-900 block">Weekdays Only</span>
                                    <span class="text-xs text-gray-500">Select Monday-Friday</span>
                                </div>
                            </div>
                        </button>
                        
                        <button onclick="selectWeekend()" 
                                class="w-full flex items-center justify-between p-3 bg-white rounded-lg border border-yellow-200 hover:border-yellow-400 transition-colors">
                            <div class="flex items-center">
                                <div class="w-8 h-8 rounded-lg bg-purple-100 flex items-center justify-center mr-3">
                                    <i class="fas fa-umbrella-beach text-purple-600"></i>
                                </div>
                                <div>
                                    <span class="font-medium text-gray-900 block">Weekend Only</span>
                                    <span class="text-xs text-gray-500">Select Saturday-Sunday</span>
                                </div>
                            </div>
                        </button>
                        
                        <button onclick="selectAllDays()" 
                                class="w-full flex items-center justify-between p-3 bg-white rounded-lg border border-yellow-200 hover:border-yellow-400 transition-colors">
                            <div class="flex items-center">
                                <div class="w-8 h-8 rounded-lg bg-green-100 flex items-center justify-center mr-3">
                                    <i class="fas fa-calendar-alt text-green-600"></i>
                                </div>
                                <div>
                                    <span class="font-medium text-gray-900 block">All Days</span>
                                    <span class="text-xs text-gray-500">Select every day</span>
                                </div>
                            </div>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Load existing availability data
    loadAvailabilityData();
    
    // Set up event listeners for checkboxes and time inputs
    setupEventListeners();
    
    // Initial preview update
    updateSchedulePreview();
});

// Days of week data - UPDATED: All days active with 9AM-9PM
const daysData = [
    { id: 0, name: "Monday", is_active: true, start_time: "09:00", end_time: "21:00" },
    { id: 1, name: "Tuesday", is_active: true, start_time: "09:00", end_time: "21:00" },
    { id: 2, name: "Wednesday", is_active: true, start_time: "09:00", end_time: "21:00" },
    { id: 3, name: "Thursday", is_active: true, start_time: "09:00", end_time: "21:00" },
    { id: 4, name: "Friday", is_active: true, start_time: "09:00", end_time: "21:00" },
    { id: 5, name: "Saturday", is_active: true, start_time: "09:00", end_time: "21:00" },
    { id: 6, name: "Sunday", is_active: true, start_time: "09:00", end_time: "21:00" }
];

function setupEventListeners() {
    // Checkbox change events
    document.querySelectorAll('.day-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const dayId = parseInt(this.dataset.dayId);
            const dayData = daysData.find(d => d.id === dayId);
            if (dayData) {
                dayData.is_active = this.checked;
                updateDayUI(dayId);
                updateSchedulePreview();
            }
        });
    });
    
    // Time input change events
    document.querySelectorAll('.time-input').forEach(input => {
        input.addEventListener('change', function() {
            const dayId = parseInt(this.dataset.dayId);
            const dayData = daysData.find(d => d.id === dayId);
            if (dayData) {
                if (this.id.startsWith('start-')) {
                    dayData.start_time = this.value;
                } else {
                    dayData.end_time = this.value;
                }
                updateTimeDisplay(dayId);
                updateSchedulePreview();
            }
        });
    });
}

function updateDayUI(dayId) {
    const dayData = daysData.find(d => d.id === dayId);
    if (!dayData) return;
    
    const container = document.getElementById(`day-${dayId}-container`);
    const timeControls = document.getElementById(`time-controls-${dayId}`);
    const preview = document.getElementById(`preview-${dayId}`);
    
    if (dayData.is_active) {
        container.classList.add('border-blue-300', 'bg-blue-50');
        timeControls.classList.remove('opacity-50');
        timeControls.querySelectorAll('input').forEach(input => {
            input.disabled = false;
        });
        preview.classList.remove('hidden');
    } else {
        container.classList.remove('border-blue-300', 'bg-blue-50');
        timeControls.classList.add('opacity-50');
        timeControls.querySelectorAll('input').forEach(input => {
            input.disabled = true;
        });
        preview.classList.add('hidden');
    }
}

function updateTimeDisplay(dayId) {
    const dayData = daysData.find(d => d.id === dayId);
    if (!dayData) return;
    
    const displayElement = document.getElementById(`time-display-${dayId}`);
    if (displayElement) {
        const startTime = formatTimeForDisplay(dayData.start_time);
        const endTime = formatTimeForDisplay(dayData.end_time);
        displayElement.textContent = `${startTime} - ${endTime}`;
    }
}

function formatTimeForDisplay(time24) {
    if (!time24) return "N/A";
    
    const [hours, minutes] = time24.split(':').map(Number);
    const ampm = hours >= 12 ? 'PM' : 'AM';
    const displayHours = hours % 12 || 12;
    return `${displayHours}:${minutes.toString().padStart(2, '0')} ${ampm}`;
}

async function loadAvailabilityData() {
    try {
        const response = await fetch('/api/mentor/availability/data');
        const data = await response.json();
        
        if (data.success && data.days) {
            // Update daysData with loaded data
            data.days.forEach(loadedDay => {
                const dayIndex = daysData.findIndex(d => d.id === loadedDay.id);
                if (dayIndex !== -1) {
                    daysData[dayIndex] = { ...daysData[dayIndex], ...loadedDay };
                }
            });
            
            // Update UI
            daysData.forEach(day => {
                const checkbox = document.getElementById(`day-${day.id}`);
                const startInput = document.getElementById(`start-${day.id}`);
                const endInput = document.getElementById(`end-${day.id}`);
                
                if (checkbox) checkbox.checked = day.is_active;
                if (startInput) startInput.value = day.start_time;
                if (endInput) endInput.value = day.end_time;
                
                updateDayUI(day.id);
                updateTimeDisplay(day.id);
            });
            
            // Load exceptions
            if (data.exceptions && data.exceptions.length > 0) {
                renderExceptions(data.exceptions);
            }
        }
    } catch (error) {
        console.error('Error loading availability data:', error);
        // Use default data already set
    }
    
    // Initialize UI with current data
    daysData.forEach(day => {
        updateDayUI(day.id);
        updateTimeDisplay(day.id);
    });
    updateSchedulePreview();
}

function updateSchedulePreview() {
    const activeDays = daysData.filter(day => day.is_active);
    const previewContainer = document.getElementById('schedule-preview');
    const nextDatesContainer = document.getElementById('next-dates');
    
    if (!previewContainer || !nextDatesContainer) return;
    
    if (activeDays.length === 0) {
        previewContainer.innerHTML = `
            <div class="text-center py-4">
                <p class="text-gray-600"><i class="fas fa-calendar-times mr-2"></i>No days selected</p>
                <p class="text-sm text-gray-500 mt-1">Select days to see your schedule</p>
            </div>
        `;
        nextDatesContainer.innerHTML = '<p class="text-gray-500">Select available days first</p>';
        return;
    }
    
    // Generate schedule preview
    let previewHTML = '';
    activeDays.forEach(day => {
        const startTime = formatTimeForDisplay(day.start_time);
        const endTime = formatTimeForDisplay(day.end_time);
        
        previewHTML += `
            <div class="flex items-center justify-between p-2 bg-white rounded-lg border border-green-200">
                <span class="font-medium text-gray-700">${day.name}</span>
                <span class="text-sm text-green-700">${startTime} - ${endTime}</span>
            </div>
        `;
    });
    
    previewContainer.innerHTML = previewHTML;
    
    // Calculate next available dates
    const today = new Date();
    const nextDates = [];
    
    for (let i = 0; i < 7 && nextDates.length < 3; i++) {
        const date = new Date(today);
        date.setDate(today.getDate() + i);
        const dayOfWeek = date.getDay(); // 0 = Sunday, 1 = Monday, etc.
        
        // Adjust for our day IDs (0 = Monday, 6 = Sunday)
        let dayId = dayOfWeek - 1;
        if (dayId < 0) dayId = 6; // Sunday
        
        const isActive = daysData.find(d => d.id === dayId)?.is_active;
        
        if (isActive) {
            const dateStr = date.toLocaleDateString('en-US', { 
                weekday: 'short', 
                month: 'short', 
                day: 'numeric' 
            });
            nextDates.push(dateStr);
        }
    }
    
    if (nextDates.length > 0) {
        nextDatesContainer.innerHTML = nextDates.map(date => 
            `<div class="flex items-center mb-1">
                <i class="fas fa-calendar-day mr-2 text-green-500"></i>
                <span>${date}</span>
            </div>`
        ).join('');
    } else {
        nextDatesContainer.innerHTML = '<p class="text-gray-500">No upcoming available dates</p>';
    }
}

async function saveAvailability() {
    const saveBtn = document.getElementById('save-btn');
    const originalText = saveBtn.innerHTML;
    
    try {
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Saving...';
        saveBtn.disabled = true;
        
        const response = await fetch('/mentor/availability/simple/update', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ days: daysData })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showNotification('Availability saved successfully!', 'success');
            // Reload data to get any updates
            loadAvailabilityData();
        } else {
            showNotification('Error: ' + result.message, 'error');
        }
    } catch (error) {
        console.error('Error saving availability:', error);
        showNotification('Failed to save availability. Please try again.', 'error');
    } finally {
        saveBtn.innerHTML = originalText;
        saveBtn.disabled = false;
    }
}

function resetToDefault() {
    if (confirm('Reset to default schedule (All days 9AM-9PM)?')) {
        daysData.forEach(day => {
            day.is_active = true;  // All days active
            day.start_time = "09:00";  // 9 AM
            day.end_time = "21:00";    // 9 PM
            
            const checkbox = document.getElementById(`day-${day.id}`);
            const startInput = document.getElementById(`start-${day.id}`);
            const endInput = document.getElementById(`end-${day.id}`);
            
            if (checkbox) checkbox.checked = day.is_active;
            if (startInput) startInput.value = day.start_time;
            if (endInput) endInput.value = day.end_time;
            
            updateDayUI(day.id);
            updateTimeDisplay(day.id);
        });
        
        updateSchedulePreview();
        showNotification('Reset to default schedule (All days 9AM-9PM)', 'info');
    }
}

function setTimePreset(startTime, endTime) {
    daysData.forEach(day => {
        if (day.is_active) {
            day.start_time = startTime;
            day.end_time = endTime;
            
            const startInput = document.getElementById(`start-${day.id}`);
            const endInput = document.getElementById(`end-${day.id}`);
            
            if (startInput) startInput.value = startTime;
            if (endInput) endInput.value = endTime;
            
            updateTimeDisplay(day.id);
        }
    });
    
    updateSchedulePreview();
    showNotification(`Time set to ${formatTimeForDisplay(startTime)} - ${formatTimeForDisplay(endTime)} for active days`, 'success');
}

async function addException() {
    const dateInput = document.getElementById('exception-date');
    const reasonInput = document.getElementById('exception-reason');
    
    if (!dateInput.value) {
        showNotification('Please select a date', 'error');
        return;
    }
    
    try {
        const formData = new FormData();
        formData.append('date', dateInput.value);
        formData.append('is_available', 'false');
        formData.append('reason', reasonInput.value || '');
        
        const response = await fetch('/mentor/availability/exceptions/add', {
            method: 'POST',
            body: formData
        });
        
        if (response.ok) {
            showNotification('Date marked as unavailable', 'success');
            dateInput.value = '';
            reasonInput.value = '';
            // Reload exceptions
            loadAvailabilityData();
        } else {
            showNotification('Failed to add exception', 'error');
        }
    } catch (error) {
        console.error('Error adding exception:', error);
        showNotification('Failed to add exception', 'error');
    }
}

function renderExceptions(exceptions) {
    const container = document.getElementById('exceptions-list');
    if (!exceptions || exceptions.length === 0) {
        container.innerHTML = `
            <div class="text-center py-8">
                <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-gray-100 flex items-center justify-center">
                    <i class="fas fa-calendar text-gray-400 text-2xl"></i>
                </div>
                <h3 class="text-lg font-semibold text-gray-900 mb-2">No Special Dates</h3>
                <p class="text-gray-500">Add dates when you're not available despite your weekly schedule</p>
            </div>
        `;
        return;
    }
    
    let html = '<h3 class="font-medium text-gray-900 mb-4">Upcoming Unavailable Dates:</h3>';
    html += '<div class="space-y-3">';
    
    exceptions.forEach(exception => {
        html += `
            <div class="flex items-center justify-between bg-red-50 p-4 rounded-lg border border-red-200">
                <div>
                    <span class="font-medium text-red-800">${exception.date}</span>
                    ${exception.reason ? `<p class="text-sm text-red-600 mt-1">${exception.reason}</p>` : ''}
                </div>
                <button onclick="removeException(${exception.id})" 
                        class="text-red-500 hover:text-red-700 hover:bg-red-100 p-2 rounded-lg transition-colors"
                        title="Remove exception">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
}

async function removeException(exceptionId) {
    if (confirm('Are you sure you want to remove this exception?')) {
        try {
            const response = await fetch(`/mentor/availability/exceptions/${exceptionId}/delete`, {
                method: 'DELETE'
            });
            
            if (response.ok) {
                showNotification('Exception removed', 'success');
                // Reload data
                loadAvailabilityData();
            }
        } catch (error) {
            console.error('Error removing exception:', error);
            showNotification('Failed to remove exception', 'error');
        }
    }
}

// Quick action functions
function selectWeekdays() {
    daysData.forEach(day => {
        day.is_active = day.id < 5;  // Only Monday-Friday
        const checkbox = document.getElementById(`day-${day.id}`);
        if (checkbox) checkbox.checked = day.is_active;
        updateDayUI(day.id);
    });
    updateSchedulePreview();
    showNotification('Selected weekdays only', 'success');
}

function selectWeekend() {
    daysData.forEach(day => {
        day.is_active = day.id >= 5;  // Only Saturday-Sunday
        const checkbox = document.getElementById(`day-${day.id}`);
        if (checkbox) checkbox.checked = day.is_active;
        updateDayUI(day.id);
    });
    updateSchedulePreview();
    showNotification('Selected weekend only', 'success');
}

function selectAllDays() {
    daysData.forEach(day => {
        day.is_active = true;  // All days
        const checkbox = document.getElementById(`day-${day.id}`);
        if (checkbox) checkbox.checked = true;
        updateDayUI(day.id);
    });
    updateSchedulePreview();
    showNotification('Selected all days', 'success');
}

function showNotification(message, type) {
    // Remove any existing notifications
    document.querySelectorAll('.notification-toast').forEach(el => el.remove());
    
    const icon = type === 'success' ? 'fa-check-circle' : 
                 type === 'error' ? 'fa-exclamation-circle' : 
                 'fa-info-circle';
    
    const bgColor = type === 'success' ? 'bg-green-500' : 
                    type === 'error' ? 'bg-red-500' : 
                    'bg-blue-500';
    
    const notification = document.createElement('div');
    notification.className = `notification-toast fixed top-6 right-6 px-6 py-4 rounded-xl shadow-2xl z-50 transform transition-all duration-300 ${bgColor} text-white max-w-sm`;
    notification.innerHTML = `
        <div class="flex items-center gap-3">
            <i class="fas ${icon} text-xl"></i>
            <span class="font-medium">${message}</span>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Remove after 4 seconds
    setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 4000);
}
</script>

<style>
.notification-toast {
    animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

.day-checkbox:checked + label {
    color: #2563eb; /* blue-600 */
}

.time-input:disabled {
    background-color: #f9fafb; /* gray-50 */
    cursor: not-allowed;
}
</style>
{% endblock %}
